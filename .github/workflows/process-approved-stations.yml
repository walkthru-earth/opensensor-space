# Process approved station contributions after PR merge
# Merges new stations into stations.csv and creates PR to main

name: Process Approved Stations

on:
  push:
    branches:
      - contributions-clean
    paths:
      - 'content/stations/**'

jobs:
  merge-stations:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup DuckDB
        run: |
          curl -L https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip -o duckdb.zip
          unzip duckdb.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Merge new stations to CSV
        run: |
          echo "Running merge script..."
          duckdb -c ".read scripts/merge-station-contributions.sql"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet sources/stations/stations.csv; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## New Stations Added" >> $GITHUB_STEP_SUMMARY
            git diff sources/stations/stations.csv | head -50 >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create PR to main
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch for the update
          BRANCH_NAME="station-update-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git add sources/stations/stations.csv
          git commit -m "feat(stations): add approved station contributions

          Auto-merged from contributions-clean branch"

          # Push and create PR
          git push origin "$BRANCH_NAME"

          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Add approved station contributions" \
            --body "## Approved Stations

          This PR adds newly approved stations from the contribution workflow.

          ### Changes
          - Updated \`sources/stations/stations.csv\` with new entries

          ### Review
          - Stations have been validated (S3 URLs checked)
          - Ready to merge to update the dashboard"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
